<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title> Test platformer </title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var config = {
    type: Phaser.AUTO,
    width: 1920,
    height: 600,
    physics: {
        default: 'arcade',
        arcade: {
            gravity: { y: 1800 },
            debug: true
        }
    },
    scene: {
        preload: preload,
        create: create,
        update: update,
    }
};
    
var game = new Phaser.Game(config);
    
    //VARIABLES ------------------------------------------------------------------------------------
    
var player;
var sol;
var cursors;
var ennemi;
var plateforme;
var tirer = false;

function preload ()
{
    this.load.image('fond_test', 'assets_test/fond_test.png');
    this.load.image('perso_test', 'assets_test/perso_test.png');
    this.load.image('sol', 'assets_test/bon_sol.png');
    this.load.image('ennemi', 'assets_test/ennemi_test.png');
    this.load.spritesheet('dude', 'assets/spritesheet_perso.png', { frameWidth: 30, frameHeight: 45});

    
}
    
    
function create ()
{
    
    //CREATION DE LA MAP -----------------------------------------------------------------------------
    this.add.image(960, 300, 'fond_test');
    sol = this.physics.add.image(960, 400, 'sol');
    sol.setCollideWorldBounds(true);
    plateforme = this.physics.add.staticGroup();
    plateforme.create(1800, 0, 'sol');
    
    //CREATION PLAYER --------------------------------------------------------------------------------
    //player = this.physics.add.image(960, 300, 'perso_test');
    //player.setCollideWorldBounds(true);
    player = this.physics.add.sprite(this.positionX, this.positionY, 'dude').setSize(28, 15).setOffset(2, 33);
    player.direction = 'down';
    player.setCollideWorldBounds(true);
    //CREATION ENNEMI -------------------------------------------------------------------------------
    ennemi = this.physics.add.image(1200, 300, 'ennemi');
    ennemi.setCollideWorldBounds(true);
    
    //AJOUT VARIABLE TOUCHES CLAVIER ------------------------------------------------------------------
    cursors = this.input.keyboard.createCursorKeys();

    //AJOUT DES COLLIDERS ------------------------------------------------------------------------------
    this.physics.add.collider(player, sol);
    this.physics.add.collider(player, ennemi);
    this.physics.add.collider(ennemi, sol);
    this.physics.add.collider(player, plateforme);
    
    this.cameras.main.setBounds(0, 0, 1920, 600)
    this.cameras.main.setSize(800, 600);
    this.cameras.main.startFollow(player);
    
    this.anims.create({
            key: 'left',
            frames: this.anims.generateFrameNumbers('dude', { start: 1, end: 3 }),
            frameRate: 10,
        });

    this.anims.create({
            key: 'right',
            frames: this.anims.generateFrameNumbers('dude', { start: 4, end: 6 }),
            frameRate: 10,
        });

    this.anims.create({
            key: 'reste_right',
            frames: [ {key: 'dude', frame: 4}],
        });

    this.anims.create({
            key: 'reste_left',
            frames: [{key: 'dude', frame: 3}],
        });
    
    this.anims.create({
            key: 'shoot_left',
            frames: [{key: 'dude', frame : 0}],
    })
    
    this.anims.create({
            key: 'shoot_right',
            frames: [{key: 'dude', frame : 7}],
    })
    
    this.hook = this.physics.add.group({});

    
    this.input.on('pointerdown', shoot, this);
    
}
    
    
    
function update ()
{
    
    if (cursors.left.isDown)
    {
        player.setVelocityX(-300);
        player.direction = 'left';
        player.anims.play('left', true);
    }
    
    else if (cursors.right.isDown)
    {
        player.setVelocityX(300);
        player.direction = 'right';
        player.anims.play('right', true);
    }
    
    else
    {
        player.setVelocityX(0);
        if (player.direction == 'left'){
            player.anims.play('shoot_left');
        }
        else if(player.direction == 'right'){
            player.anims.play('shoot_right');
        }
    }
    
    if(cursors.up.isDown)
    {
        player.setVelocityY(-300);
    }
    
    

    if (cursors.down.isDown){
        player.setVelocityY(300)
    }

}

function shoot (pointer){    
    console.log(pointer.x, pointer.y);
    console.log(player.x, player.y);
    console.log(this.cameras.main.scrollX, this.cameras.main.scrollY);
    
      var hook = this.hook.get(player.x, player.y);
      if (hook) {
        hook.setActive(true);
        hook.setVisible(true);
          //Calcul de coordonnées du vecteur entre les deux projectiles
          dY = ( pointer.y - player.y);
          
          pointer.x += this.cameras.main.scrollX
          
          if(pointer.x > player.x){
          dX = (pointer.x - player.x);
          }
          
          else if(pointer.x < player.x){
              dX = (pointer.x - player.x);
          }

          //Distance à ajouter pour atteindre la constante vitesse.
          dSpeed = (1300/(Math.abs(dY)+Math.abs(dX))); 

          hook.body.setAllowGravity(false);
          hook.body.velocity.y = dY*dSpeed;
          hook.body.velocity.x = dX*dSpeed;
        }
}
    
    
function hookHitEnnemies(hook, ennemi){
     scene.physics.moveToObject(ennemi, this.hook, this.grappin.dSpeed);
}

    
    
</script>
    
</body>
</html>